<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <button id="record">Record</button>
</body>

<script>

//使用 WebSocket 的網址向 Server 開啟連結
let ws = new WebSocket('ws://192.168.31.39:8765')

//開啟後執行的動作，指定一個 function 會在連結 WebSocket 後執行
ws.onopen = () => {
    console.log('open connection');

    ws.send(JSON.stringify({
            "apikey":"123",
            "config": {
                "language_code":"cmn-CN",
                "sample_rate":"16000"
            }
        })
    );
}

//關閉後執行的動作，指定一個 function 會在連結中斷後執行
ws.onclose = () => {
    console.log('close connection')
}

ws.onmessage = (event) => {
    console.log("recv message:" + event.data)
}



(function () {
    'use strict';
    
    const audioContext = new AudioContext();
    const recordButton = document.querySelector('#record');
    
    navigator.mediaDevices.getUserMedia({ audio: {
        sampleRate:16000,
        channelCount:1
    } })
        .then(attachEvents);
    
    function attachEvents(sourceStream) {
        const data = [];
        let mediaRecorder;
        let isRecording = false;
        
        recordButton.onclick = () => {
            isRecording = !isRecording;
            
            if (isRecording) {
                mediaRecorder = record(sourceStream);
            } else {
                mediaRecorder.stop();
            }
            
            updateButton(isRecording);
        };
    }
    
    function record(sourceStream) {
        const mediaRecorder = new MediaRecorder(sourceStream);
        const data = [];
        const timeslice = 200;

        mediaRecorder.ondataavailable = e =>{
            e.data.size && data.push(e.data);
            e.data.size && e.data.arrayBuffer().then(buffer=>ws.send(buffer));
        } 
        mediaRecorder.start(timeslice);
        mediaRecorder.onstop = () => process(data);
        
        return mediaRecorder;
    }
    
    function process(data) {
        const blob = new Blob(data);
        
        convertToArrayBuffer(blob)
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(play);
    }
    
    function convertToArrayBuffer(blob) {
        const url = URL.createObjectURL(blob);
        
        return fetch(url).then(response => {
            return response.arrayBuffer();
        });
    }
    
    function play(audioBuffer) {
        const sourceNode = audioContext.createBufferSource();
        
        sourceNode.buffer = audioBuffer;
        sourceNode.detune.value = -300;
        
        sourceNode.connect(audioContext.destination);
        sourceNode.start();
    }
    
    function updateButton(isRecording) {
        recordButton.innerHTML = isRecording ? 'Stop' : 'Record';
    }
}());
</script>
</html>